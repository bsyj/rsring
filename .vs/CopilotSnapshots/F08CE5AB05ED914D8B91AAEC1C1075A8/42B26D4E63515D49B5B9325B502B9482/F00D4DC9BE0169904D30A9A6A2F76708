package com.moremod.network;

import io.netty.buffer.ByteBuf;
import net.minecraftforge.fml.common.network.simpleimpl.IMessage;
import net.minecraftforge.fml.common.network.simpleimpl.IMessageHandler;
import net.minecraftforge.fml.common.network.simpleimpl.MessageContext;
import net.minecraftforge.fml.common.network.ByteBufUtils;
import net.minecraft.entity.player.EntityPlayerMP;
import com.moremod.item.ItemChestRing;
import com.moremod.capability.IRsRingCapability;
import com.moremod.capability.RsRingCapability;
import net.minecraft.item.ItemStack;

/** 客户端 -> 服务器：同步戒指过滤器和模式设置 */
public class PacketSyncRingFilter implements IMessage {

    private boolean whitelistMode;
    private String[] slots = new String[9];

    public PacketSyncRingFilter() {}

    public PacketSyncRingFilter(boolean whitelistMode, String[] slots) {
        this.whitelistMode = whitelistMode;
        if (slots != null) {
            for (int i = 0; i < Math.min(9, slots.length); i++) this.slots[i] = slots[i];
        }
    }

    @Override
    public void fromBytes(ByteBuf buf) {
        whitelistMode = buf.readBoolean();
        for (int i = 0; i < 9; i++) {
            boolean has = buf.readBoolean();
            if (has) slots[i] = ByteBufUtils.readUTF8String(buf);
            else slots[i] = "";
        }
    }

    @Override
    public void toBytes(ByteBuf buf) {
        buf.writeBoolean(whitelistMode);
        for (int i = 0; i < 9; i++) {
            String s = slots[i];
            if (s != null && !s.isEmpty()) {
                buf.writeBoolean(true);
                ByteBufUtils.writeUTF8String(buf, s);
            } else {
                buf.writeBoolean(false);
            }
        }
    }

    public static class Handler implements IMessageHandler<PacketSyncRingFilter, IMessage> {
        @Override
        public IMessage onMessage(PacketSyncRingFilter msg, MessageContext ctx) {
            EntityPlayerMP player = ctx.getServerHandler().player;
            player.getServerWorld().addScheduledTask(() -> {
                // 在服务器端查找对应的箱子戒指：优先使用统一的 RingDetectionService（支持 Baubles）
                ItemStack stack = com.moremod.service.RingDetectionService.findRing(player, com.moremod.item.ItemChestRing.class);
                // 回退到手持查找（兼容旧逻辑）
                if (stack == null || stack.isEmpty()) {
                    stack = player.getHeldItemMainhand();
                    if (stack.isEmpty() || !(stack.getItem() instanceof ItemChestRing)) {
                        stack = player.getHeldItemOffhand();
                    }
                }
                if (stack == null || stack.isEmpty() || !(stack.getItem() instanceof ItemChestRing)) return;

                IRsRingCapability cap = stack.getCapability(RsRingCapability.RS_RING_CAPABILITY, null);
                if (cap == null) return;

                cap.setWhitelistMode(msg.whitelistMode);
                for (int i = 0; i < 9; i++) {
                    cap.setFilterSlot(i, msg.slots[i] == null ? "" : msg.slots[i]);
                }
                RsRingCapability.syncCapabilityToStack(stack, cap);
            });
            return null;
        }
    }
}
